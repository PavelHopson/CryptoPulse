# CryptoPulse 2077 — Полный обзор продукта

Документ описывает полный состав сайта, бизнес-логику, пользовательские сценарии, платежный контур и эксплуатационную архитектуру.

---

## 1) Карта сайта

### Публичная зона
- `/auth` — вход (email/password + OAuth)

### Защищенная зона
- `/` — Дашборд рынка
- `/favorites` — Избранное
- `/comparison` — Сравнение монет
- `/portfolio` — Портфель (Pro+)
- `/pricing` — Тарифы и апгрейд
- `/billing` — Биллинг и подписка

---

## 2) Роли и доступ

| Роль | Избранное | Сравнение | Портфель | Alerts | Биллинг |
|---|---:|---:|---|---|---|
| Free | Ограничено флагами | Ограничено флагами | Нет | Нет | Да |
| Pro | Расширенные лимиты | Расширенные лимиты | Да | Да | Да |
| Enterprise | Безлимит/кастом | Безлимит/кастом | Да | Да | Да |

Лимиты управляются через таблицу `feature_flags`.

---

## 3) Функциональные модули

### Дашборд
- топовые активы
- цена, 24h %, капитализация, объем
- 7d sparkline
- регулярный авто-refresh

### Избранное
- добавление/удаление
- лимиты по роли
- realtime-синхронизация
- graceful downgrade (лишние записи → inactive)

### Сравнение
- лимиты из feature flags
- база для мультиграфиков и стратегий

### Портфель
- доступ только Pro+
- база для ROI/P&L аналитики

### Тарифы
- Pro / Enterprise
- запуск Stripe checkout
- события аналитики на апгрейд

### Биллинг
- статус подписки
- next renewal
- trial countdown
- cancel at period end
- история инвойсов

---

## 4) Жизненный цикл подписки

1. Пользователь запускает checkout.
2. Stripe создает/обновляет подписку.
3. Webhook получает события.
4. Система обновляет:
   - `subscriptions`
   - `profiles.role`
   - `subscription_events` (audit)
5. UI-ограничения меняются автоматически по роли/флагам.

---

## 5) Ключевые таблицы

- `profiles` — профиль + роль
- `subscriptions` — статус и периоды подписки
- `subscription_events` — аудит событий Stripe
- `feature_flags` — лимиты и доступность функций
- `favorites` — watchlist пользователя
- `comparisons` — сохраненные сравнения
- `portfolios` — портфель пользователя
- `alerts` — ценовые алерты
- `alert_jobs` — очередь задач алертов
- `usage_events` — продуктовая аналитика

---

## 6) Безопасность и эксплуатация

### Безопасность
- RLS на пользовательских данных
- webhook signature validation
- секреты только в env/edge

### Эксплуатация
- structured logging
- централизованная обработка ошибок
- health-check endpoint + scheduled checks
- retries и failure hooks

---

## 7) Growth и аналитика

- сбор usage событий
- MRR snapshot
- churn view по подпискам
- триггеры апгрейда в продуктовых точках

---

## 8) Итог

CryptoPulse — это не просто интерфейс с графиками, а SaaS-платформа с готовым фундаментом для запуска, монетизации и масштабирования.
